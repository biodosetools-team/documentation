# Usage (R API) {#manual-use-r}

The following examples illustrate the functionality of {biodosetools}'s R API to perform dose-effect fitting and dose estimation for the dicentric and translocation assays. The equivalent examples using the {shiny} user interface can be found in Chapter \@ref(manual-use-shiny).

The full {biodosetools} R API reference detailing the available functions and parameters can be found on the project's website at https://biodosetools-team.github.io/biodosetools/reference/.

## Dicentrics dose-effect fitting

### Input count data

The first step is to input the count data. This step is accomplished in \proglang{R} by calling the `calculate_aberr_table()` function. This will calculate the total number of cells ($N$), total number of aberrations ($X$), as well as mean ($\bar{y}$), variance ($\sigma^{2}$), dispersion index ($\sigma^{2}/\bar{y}$), and $u$-value.
```{r dic-count-data}
count_data <- system.file("extdata", "count-data-barquinero-1995.csv",
  package = "biodosetools"
) |>
  utils::read.csv() |>
  calculate_aberr_table(type = "count")
```

```{r dic-count-data-r}
count_data
```

### Perform fitting

To perform the fitting in \proglang{R} we call the `fit()` function, whilst selecting the appropriate `aberr_module` (`"dicentrics"` in this example), `model_formula` (`"lin-quad"` or `"lin"` for LQ or L models, respectively), and `model_family` (`"automatic"`, `"poisson"`, or `"quasipoisson"`) parameters:
```{r dic-fit-results}
fit_results <- fit(
  count_data = count_data,
  model_formula = "lin-quad",
  model_family = "automatic",
  aberr_module = "dicentrics"
)
```

The `fit_results` object is a list that contains all necessary information about the count data as well as options selected when performing the fitting. This is a vital step to ensure traceability and reproducibility. Below we can see its elements:
```{r dic-fit-results-names}
names(fit_results)
```

In particular, we can see how `fit_coeffs` matches the results obtained in the UI (Figure \@ref(fig:sc-dic-fit-03)):

```{r dic-fit-coeffs-r}
fit_results$fit_coeffs
```

To visualise the dose-effect curve, we call the `plot_fit_dose_curve()` function:

```{r dic-fit-dose-curve, out.width="100%", fig.dpi=300, fig.align="center", fig.height=3, fig.width=6, fig.cap="Plot of dose-effect curve generated by {biodosetools}. The grey shading indicates the uncertainties associated with the calibration curve."}
plot_fit_dose_curve(
  fit_results,
  aberr_name = "Dicentrics"
)
```

## Dicentrics dose estimation

### Input case data

Next we can choose to either load the case data from a file or to input the data manually. The data is then parsed in \proglang{R} by calling the `calculate_aberr_table()` function. This will calculate the total number of cells ($N$), total number of aberrations ($X$), as well as mean ($\bar{y}$), standard error ($\sigma$), dispersion index ($\sigma^{2}/\bar{y}$), and $u$-value.
```{r dic-case-data}
case_data <- system.file("extdata", "cases-data-partial.csv",
  package = "biodosetools"
) |>
  utils::read.csv(header = TRUE) |>
  calculate_aberr_table(
    type = "case",
    assessment_u = 1,
    aberr_module = "dicentrics"
  )
```

```{r dic-case-data-r}
case_data
```

### Perform dose estimation

Finally, to perform the dose estimation in \proglang{R} we can call the adequate `estimate_*()` functions and parameters depending on the characteristics of the accident. In this example, we will use `estimate_whole_body_merkle()` and `estimate_partial_body_dolphin()`. First of all, however, we will need to load the fit coefficients and variance-covariance matrix from the previously calculated `fit_results`:
```{r dic-parse-fit-results}
fit_coeffs <- fit_results[["fit_coeffs"]]
fit_var_cov_mat <- fit_results[["fit_var_cov_mat"]]
```

After that is done, we can simply call `estimate_whole_body_merkle()` and `estimate_partial_body_dolphin()`:

```{r dic-dose-estimation-whole}
results_whole_merkle <- estimate_whole_body_merkle(
  case_data,
  fit_coeffs,
  fit_var_cov_mat,
  conf_int_yield = 0.83,
  conf_int_curve = 0.83,
  protracted_g_value = 1,
  aberr_module = "dicentrics"
)
```

```{r dic-dose-estimation-partial}
results_partial <- estimate_partial_body_dolphin(
  case_data,
  fit_coeffs,
  fit_var_cov_mat,
  conf_int = 0.95,
  gamma = 1 / 2.7,
  aberr_module = "dicentrics"
)
```

To visualise the estimated doses, we call the `plot_estimated_dose_curve()` function:

```{r dic-estimated-dose-curve, eval=FALSE, echo=TRUE}
plot_estimated_dose_curve(
  est_doses = list(
    whole = results_whole_merkle,
    partial = results_partial
  ),
  fit_coeffs,
  fit_var_cov_mat,
  protracted_g_value = 1,
  conf_int_curve = 0.95,
  aberr_name = "Dicentrics"
)
```

```{r dic-estimated-dose-curve-fix, echo=FALSE, message=FALSE, out.width="100%", fig.dpi=300, fig.align="center", fig.height=3, fig.width=6, fig.cap="Plot of estimated doses generated by {biodosetools}. The grey shading indicates the uncertainties associated with the calibration curve."}
plot_estimated_dose_curve(
  est_doses = list(
    whole = results_whole_merkle,
    partial = results_partial
  ),
  fit_coeffs,
  fit_var_cov_mat,
  protracted_g_value = 1,
  conf_int_curve = 0.95,
  aberr_name = "Dicentrics"
) |>
  fix_estimated_dose_curve_color_labels(
    breaks = c("Whole-body", "Partial-body"),
    labels = c("Whole-body (83\\%-83\\%)", "Partial-body (95\\%)")
  )
```


## Translocations dose-effect fitting

### Calculate genomic conversion factor

To be able to fit the equivalent full genome dose-effect curve, we need to calculate the genomic conversion factor. To calculate the genomic conversion factor in R we call the `calculate_genome_factor()` function:

```{r trans-genome-factor-fit}
genome_factor <- calculate_genome_factor(
  dna_table = dna_content_fractions_morton,
  chromosome = c(1, 4, 11),
  color = rep("Red", 3),
  sex = "female"
)
```

```{r trans-genome-factor-fit-r}
genome_factor
```

### Input count data

Once the genomic conversion factor has been calculated, we can input the count data. This step is accomplished in R by calling the `calculate_aberr_table()` function. This will calculate the total number of cells ($N$), total number of aberrations ($X$), as well as mean ($\bar{y}$), variance ($\sigma^{2}$), dispersion index ($\sigma^{2}/\bar{y}$), and $u$-value.

```{r trans-count-data}
count_data <- system.file("extdata", "count-data-rodriguez-2004.csv", package = "biodosetools") |>
  utils::read.csv() |>
  calculate_aberr_table(type = "count") |>
  dplyr::mutate(N = N * genome_factor)
```

```{r trans-count-data-r}
count_data
```

### Perform fitting

To perform the fitting in R we call the `fit()` function, whilst selecting the appropriate `aberr_module` (`"translocations"` in this example), `model_formula` (`"lin-quad"` or `"lin"` for LQ or L models, respectively), and `model_family` (`"automatic"`, `"poisson"`, or `"quasipoisson"`) parameters:

```{r trans-fit-results}
fit_results <- fit(
  count_data = count_data,
  model_formula = "lin-quad",
  model_family = "automatic",
  fit_link = "identity",
  aberr_module = "translocations"
)
```

The `fit_results` object is a list that contains all necessary information about the count data as well as options selected when performing the fitting. This is a vital step to ensure traceability and reproducibility. Below we can see its elements:

```{r trans-fit-results-names}
names(fit_results)
```

In particular, we can see how `fit_coeffs` matches the results obtained in the UI (Figure \@ref(fig:sc-trans-fit-04)):

```{r trans-fit-coeffs-r}
fit_results$fit_coeffs
```

To visualise the dose-effect curve, we call the `plot_fit_dose_curve()` function:

```{r trans-fit-dose-curve, fig.width=6, fig.height=3.5, fig.align='center', fig.cap="Plot of dose-effect curve generated by \\{biodosetools\\}. The grey shading indicates the uncertainties associated with the calibration curve."}
plot_fit_dose_curve(
  fit_results,
  aberr_name = "Translocations"
)
```

## Translocations dose estimation

### Calculate genomic conversion factor

To be able to fit the equivalent full genome case data, we need to calculate the genomic conversion factor.

To do this, in the "Stain color options" box we select the sex of the individual, and the list of chromosomes and stains used for the translocation assay. Clicking on "Generate table" will show a table in the "Chromosome data" box in which we select the chromosome-stain pairs. Clicking on the "Calculate fraction" will calculate the genomic conversion factor.

To calculate the genomic conversion factor in R we call the `calculate_genome_factor()` function:

```{r trans-genome-factor-est}
genome_factor <- calculate_genome_factor(
  dna_table = dna_content_fractions_morton,
  chromosome = c(1, 2, 3, 4, 5, 6),
  color = c("Red", "Red", "Green", "Red", "Green", "Green"),
  sex = "male"
)
```

```{r}
genome_factor
```

### Input case data

Next we can choose to either load the case data from a file or to input the data manually. The data is then parsed in R by calling the `calculate_aberr_table()` function. If needed, the user can select to use confounders (either using Sigurdson's method, or by inputting the translocation frequency per cell). Once the table is generated and filled, the "Calculate parameters" button will calculate the total number of cells ($N$), total number of aberrations ($X$), as well as mean ($\bar{F}_{p}$), standard error ($\sigma_{p}$), dispersion index ($\sigma^{2}/\bar{y}$), $u$-value, expected translocation rate ($X_{c}$), full genome mean ($\bar{F}_{g}$), and full genome error ($\sigma_{g}$).

```{r trans-case-data}
case_data <- data.frame(
  C0 = 288, C1 = 52, C2 = 9, C3 = 1
) |>
  calculate_aberr_table(
    type = "case",
    assessment_u = 1,
    aberr_module = "translocations"
  ) |>
  dplyr::mutate(
    Xc = calculate_trans_rate_sigurdson(
      cells = N,
      genome_factor = genome_factor,
      age_value = 30,
      smoker_bool = TRUE
    ),
    Fg = (X - Xc) / (N * genome_factor),
    Fg_err = Fp_err / sqrt(genome_factor)
  )
```

```{r}
case_data
```

### Perform dose estimation

Finally, to perform the dose estimation in R we can call the adequate `estimate_*()` functions and parameters depending on the characteristics of the accident. In this example, we will use `estimate_whole_body_delta()`. First of all, however, we will need to load the fit coefficients and variance-covariance matrix from the previously calculated `fit_results`:

```{r trans-parse-fit-results}
fit_coeffs <- fit_results$fit_coeffs
fit_var_cov_mat <- fit_results$fit_var_cov_mat
```

Since we have a protracted exposure, we need to calculate the value of $G(x)$:

```{r trans-protracted-g-value}
protracted_g_value <- protracted_g_function(
  time = 0.5,
  time_0 = 2
)
```

```{r}
protracted_g_value
```

After that is done, we can simply call `estimate_whole_body_delta()`:

```{r trans-dose-estimation-whole-delta}
results_whole_delta <- estimate_whole_body_delta(
  case_data,
  fit_coeffs,
  fit_var_cov_mat,
  conf_int = 0.95,
  protracted_g_value,
  aberr_module = "translocations"
)
```

To visualise the estimated doses, we call the `plot_estimated_dose_curve()` function:

```{r trans-estimated-dose-curve, fig.width=6, fig.height=3.5, fig.align='center', fig.cap="Plot of estimated doses generated by \\{biodosetools\\}. The grey shading indicates the uncertainties associated with the calibration curve."}
plot_estimated_dose_curve(
  est_doses = list(whole = results_whole_delta),
  fit_coeffs,
  fit_var_cov_mat,
  protracted_g_value,
  conf_int_curve = 0.95,
  aberr_name = "Translocations"
)
```
